<!DOCTYPE html>
<html lang="pt-BR" class="h-full bg-gray-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Produtos das Salas (PA e MP)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <!-- ATENÇÃO: Configuração do Firebase já preenchida -->
    <script type="module">
        // Importa as funções necessárias dos SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { 
            getFirestore, collection, doc, getDocs, onSnapshot, 
            addDoc, updateDoc, deleteDoc, setDoc, query, where, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuração do Firebase do usuário
        const firebaseConfig = {
            apiKey: "AIzaSyAqgHANmbw0wbvuTB8PrEIkvrUQhyh41Tk",
            authDomain: "controleprodutossalas.firebaseapp.com",
            projectId: "controleprodutossalas",
            storageBucket: "controleprodutossalas.firebasestorage.app",
            messagingSenderId: "961706450894",
            appId: "1:961706450894:web:385133e94015e2474b559f",
            measurementId: "G-C4FMGD6V60"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        
        // Disponibiliza as funções do Firebase globalmente para o script inline
        window.firebase = {
            app,
            db: getFirestore(app),
            auth: getAuth(app),
            collection,
            doc,
            getDocs,
            onSnapshot,
            addDoc,
            updateDoc,
            deleteDoc,
            setDoc,
            query,
            where,
            writeBatch,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken
        };
    </script>

    <style>
        /* Estilo da fonte */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Animação suave para a sidebar */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        #main-content {
            transition: margin-left 0.3s ease-in-out;
        }

        /* Estilo para o 'backdrop' do modal */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Estilo para o modal */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Toast (Notificação) */
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 100;
            transition: bottom 0.5s ease-in-out;
        }

        #toast.show {
            bottom: 2rem;
        }

        /* Tooltip (dica) para Observações */
        [data-tooltip] {
            position: relative;
            cursor: pointer;
        }
        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background-color: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: pre-wrap; /* Permite quebra de linha */
            width: max-content;
            max-width: 300px; /* Largura máxima */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
        }
        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>

<body class="h-full overflow-hidden">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar"
            class="w-64 bg-gray-900 text-white flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:translate-x-0">
            <!-- Logo / Título -->
            <div class="flex items-center justify-center h-20 border-b border-gray-700 px-4">
                <i class="fas fa-boxes-stacked fa-2x text-blue-400"></i>
                <h1 class="text-xl font-bold ml-3">Controle de Salas</h1>
            </div>

            <!-- Navegação -->
            <nav id="sidebar-nav" class="flex-1 overflow-y-auto mt-4 space-y-2 px-2"></nav>

            <!-- Botão de Adicionar Item -->
            <div class="p-4 border-t border-gray-700">
                <button id="add-item-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Item
                </button>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div id="main-content" class="flex-1 flex flex-col overflow-hidden md:ml-64">
            <!-- Header -->
            <header class="bg-white shadow-md h-20 flex items-center justify-between px-6 z-20">
                <!-- Botão de Menu (Mobile) e Título da Sala -->
                <div class="flex items-center">
                    <button id="menu-toggle-btn" class="text-gray-600 md:hidden mr-4">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h2 id="sala-title" class="text-2xl font-bold text-gray-800">Boas-Vindas</h2>
                </div>

                <!-- Busca -->
                <div class="relative w-full max-w-md">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="search-bar" placeholder="Buscar por código ou descrição..."
                        class="w-full pl-12 pr-4 py-2.5 border border-gray-300 rounded-full bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </header>

            <!-- Área de Conteúdo (Cards) -->
            <main id="content-area" class="flex-1 overflow-y-auto p-6 bg-gray-100">
                <!-- Tela de Boas-Vindas -->
                <div id="welcome-screen" class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Bem-vindo(a) ao Controle de Produtos!</h2>
                    <p class="text-lg text-gray-600 mb-6">
                        Este é o seu painel central para gerenciar o estoque (PA e MP) de todas as salas.
                    </p>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md">
                        <h3 class="font-bold text-blue-800 text-lg mb-2">Instruções Importantes</h3>
                        <p class="text-blue-700">
                            Os produtos que você vê em cada segmento refletem o que está
                            <strong class="font-semibold">atualmente na sala</strong>.
                        </p>
                        <ul class="list-disc list-inside mt-2 text-blue-700 space-y-1">
                            <li><strong class="font-semibold">Sempre dê baixa</strong> usando o botão de retirada ( <i class="fas fa-minus-circle opacity-70"></i> ) quando um produto sair.</li>
                            <li><strong class="font-semibold">Sempre adicione</strong> um novo item ou edite a quantidade quando um produto entrar.</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Container dos Cards -->
                <div id="product-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
                    <!-- Cards de produtos serão inseridos aqui pelo JS -->
                </div>
                
                <!-- Mensagem de "Nenhum item" -->
                <div id="no-items-message" class="hidden text-center mt-20">
                     <i class="fas fa-box-open fa-4x text-gray-400 mb-4"></i>
                     <h3 class="text-2xl font-semibold text-gray-600">Nenhum item encontrado</h3>
                     <p class="text-gray-400 mt-2">Tente adicionar um novo item ou ajuste sua busca.</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Adicionar/Editar Item -->
    <div id="item-modal-backdrop" class="modal-backdrop"></div>
    <div id="item-modal" class="modal bg-white w-full max-w-lg rounded-xl shadow-2xl">
        <form id="item-form" class="flex flex-col">
            <!-- Cabeçalho do Modal -->
            <div class="flex justify-between items-center p-6 border-b">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Adicionar Novo Item</h3>
                <button type="button" class="modal-close-btn text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Conteúdo do Formulário -->
            <div class="p-6 space-y-4 overflow-y-auto max-h-[60vh]">
                <!-- Campo Escondido para ID -->
                <input type="hidden" id="item-id">
                
                <!-- Sala -->
                <div>
                    <label for="item-sala" class="block text-sm font-medium text-gray-700 mb-1">Sala</label>
                    <select id="item-sala" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Opções de sala serão preenchidas pelo JS -->
                    </select>
                </div>
                
                <!-- Código -->
                <div>
                    <label for="item-codigo" class="block text-sm font-medium text-gray-700 mb-1">Código</label>
                    <input type="text" id="item-codigo" required placeholder="Ex: PQ1234"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Descrição -->
                <div>
                    <label for="item-descricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <input type="text" id="item-descricao" required placeholder="Ex: Cafeína Anidra"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Lote -->
                <div>
                    <label for="item-lote" class="block text-sm font-medium text-gray-700 mb-1">Lote</label>
                    <input type="text" id="item-lote" placeholder="Ex: 1214/25"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Campos de Quantidade (Número) -->
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="item-quantidade" class="block text-sm font-medium text-gray-700 mb-1">Quantidade</label>
                        <input type="number" step="any" id="item-quantidade" required placeholder="Ex: 300"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="item-unidade" class="block text-sm font-medium text-gray-700 mb-1">Unidade</label>
                        <input type="text" id="item-unidade" required placeholder="Ex: g, kg, un"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="item-alerta" class="block text-sm font-medium text-gray-700 mb-1">Nível de Alerta</label>
                        <input type="number" id="item-alerta" required placeholder="Ex: 50"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Tipo (Dinâmico) -->
                <div id="tipo-container">
                    <!-- O campo de texto ou select será inserido aqui -->
                </div>

                <!-- Observações -->
                <div>
                    <label for="item-observacoes" class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="item-observacoes" rows="3" placeholder="Adicione uma nota (ex: data de validade, fornecedor...)"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
            </div>

            <!-- Rodapé do Modal -->
            <div class="flex justify-end items-center p-6 border-t bg-gray-50 rounded-b-xl space-x-4">
                <button type="button" class="modal-close-btn font-medium text-gray-600 hover:text-gray-800">Cancelar</button>
                <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Salvar</button>
            </div>
        </form>
    </div>

    <!-- Modal de Retirada (Dar Baixa) -->
    <div id="retirada-modal-backdrop" class="modal-backdrop"></div>
    <div id="retirada-modal" class="modal bg-white w-full max-w-md rounded-xl shadow-2xl">
        <form id="retirada-form" class="flex flex-col">
            <!-- Cabeçalho do Modal -->
            <div class="flex justify-between items-center p-6 border-b">
                <h3 id="retirada-modal-title" class="text-2xl font-bold text-gray-800">Dar Baixa no Estoque</h3>
                <button type="button" class="modal-close-btn text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Conteúdo do Formulário -->
            <div class="p-6 space-y-4">
                <input type="hidden" id="retirada-item-id">
                
                <p class="text-center text-lg">
                    Item: <strong id="retirada-item-nome" class="text-gray-800"></strong>
                </p>
                
                <div class="text-center p-4 bg-gray-100 rounded-lg">
                    <div class="text-sm text-gray-500">Estoque Atual</div>
                    <div id="retirada-estoque-atual" class="text-3xl font-bold text-gray-900">--</div>
                </div>

                <div>
                    <label for="retirada-quantidade" class="block text-sm font-medium text-gray-700 mb-1">Quantidade a Retirar</label>
                    <input type="number" step="any" id="retirada-quantidade" required placeholder="Ex: 100"
                        class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="retirada-motivo" class="block text-sm font-medium text-gray-700 mb-1">Motivo (Opcional)</label>
                    <input type="text" id="retirada-motivo" placeholder="Ex: Retirado por João (Lab)"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

            </div>

            <!-- Rodapé do Modal -->
            <div class="flex justify-end items-center p-6 border-t bg-gray-50 rounded-b-xl space-x-4">
                <button type="button" class="modal-close-btn font-medium text-gray-600 hover:text-gray-800">Cancelar</button>
                <button type="submit"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Confirmar Retirada</button>
            </div>
        </form>
    </div>

    <!-- Toast (Notificação) -->
    <div id="toast">Mensagem da notificação</div>
    
    <!-- Tela de Carregamento (Spinner) -->
    <div id="loading-spinner" class="fixed inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-[999]">
        <i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i>
    </div>


    <!-- JavaScript Principal -->
    <script type="module">
        // Atalhos para as funções do Firebase
        const {
            db, auth, collection, doc, getDocs, onSnapshot,
            addDoc, updateDoc, deleteDoc, setDoc, query, where, writeBatch,
            signInAnonymously, onAuthStateChanged, signInWithCustomToken
        } = window.firebase;

        // IDs da Aplicação e Usuário
        // Usamos um ID de app fixo para que os dados sejam "públicos"
        const appId = 'controle-produtos-salas-v1';
        let userId = null; // Será definido pelo Firebase Auth
        
        // Caminho da coleção pública no Firestore
        let produtosCollectionRef;

        // Estado da Aplicação
        const salas = [
            { id: 'aromas-doces', nome: 'Aromas Doces', icon: 'fa-cookie-bite', color: 'text-pink-400' },
            { id: 'aromas-salgados', nome: 'Aromas Salgados', icon: 'fa-drumstick-bite', color: 'text-yellow-600' },
            { id: 'carneos', nome: 'Cárneos', icon: 'fa-bacon', color: 'text-orange-600' },
            { id: 'lacteos', nome: 'Lácteos', icon: 'fa-cheese', color: 'text-yellow-300' },
            { id: 'nutraceuticos', nome: 'Nutracêuticos', icon: 'fa-pills', color: 'text-green-400' },
            { id: 'sorvetes', nome: 'Sorvetes', icon: 'fa-ice-cream', color: 'text-purple-400' },
        ];
        
        // Dados iniciais (só serão usados se o banco estiver vazio)
        const dadosIniciaisNutraceuticos = [
            { tipo: "BIOATIVO", codigo: "PQ993", descricao: "DHA Algas em pó", lote: "", quantidade: 300, unidade: "g" },
            { tipo: "BIOATIVO", codigo: "PQ605", descricao: "Glucoronolactona", lote: "5226/23", quantidade: 396.67, unidade: "g" },
            { tipo: "BIOATIVO", codigo: "PQ1171", descricao: "D Ribose", lote: "", quantidade: 150, unidade: "g" },
            { tipo: "BIOATIVO", codigo: "PQ1362", descricao: "D Ribose", lote: "1837/24", quantidade: 300.63, unidade: "g" },
            { tipo: "BIOATIVO", codigo: "PQ1183", descricao: "Extrato de guaraná", lote: "", quantidade: 220, unidade: "g" },
            { tipo: "BIOATIVO", codigo: "PQ1321", descricao: "Ácido Hialurônico", lote: "6296/24", quantidade: 508.25, unidade: "g" },
            { tipo: "BIOATIVO", codigo: "PQ1267", descricao: "Metil Sulfonil Metano", lote: "", quantidade: 200, unidade: "g" },
            { tipo: "BIOATIVO", codigo: "PQ614", descricao: "Cafeína Anidra", lote: "1214/25", quantidade: 399.12, unidade: "g" },
            { tipo: "FIBRAS", codigo: "PQ1255", descricao: "Psyllium P95 (Vitacel)", lote: "6798/24", quantidade: 239.10, unidade: "g" },
            { tipo: "FIBRAS", codigo: "PQ1157", descricao: "Frutooligossacarídeos (FOS)", lote: "", quantidade: 1, unidade: "kg" },
            { tipo: "FIBRAS", codigo: "PQ1161", descricao: "Polidextrose", lote: "1701/25", quantidade: 1280.78, unidade: "kg" },
            { tipo: "AMINOÁCIDOS", codigo: "PQ1164", descricao: "L- Alanina", lote: "", quantidade: 400, unidade: "g" },
            { tipo: "AMINOÁCIDOS", codigo: "PQ364", descricao: "L- Carnitina Base", lote: "5576/24", quantidade: 2.130, unidade: "kg" },
            { tipo: "MINERAIS", codigo: "PQ1007", descricao: "Bisglicinato de ferro 20% NPA", lote: "7107/24", quantidade: 395.95, unidade: "g" },
            { tipo: "MINERAIS", codigo: "PQ885", descricao: "Sulfato de zinco monohidratado", lote: "1916/25", quantidade: 395.94, unidade: "g", status: "Em Estoque" },
            { tipo: "MINERAIS", codigo: "PQ1095", descricao: "Fumarato ferroso", lote: "7144/24", quantidade: 449.40, unidade: "g" },
            { tipo: "MINERAIS", codigo: "PQ626", descricao: "Sulfato de magnésio monohidratado", lote: "0544/25", quantidade: 402.98, unidade: "g" },
            { tipo: "MINERAIS", codigo: "PQ675", descricao: "Bisglicinato de zinco 20%", lote: "1430/25", quantidade: 399.93, unidade: "g" },
            { tipo: "MINERAIS", codigo: "PQ705", descricao: "Bisgilicinato de ferro H 20%", lote: "0202/25", quantidade: 399.59, unidade: "g" },
            { tipo: "MINERAIS", codigo: "PQ1017", descricao: "Sulfato de cobre", lote: "6407/23", quantidade: 398.76, unidade: "g" },
            { tipo: "MINERAIS", codigo: "PQ766", descricao: "Cálcio citrato malato", lote: "3854/25", quantidade: 399.05, unidade: "g" },
            { tipo: "MINERAIS", codigo: "PQ676", descricao: "Bisglicinato de magnésio 30% - ORGOLABS", lote: "4623/24", quantidade: 605.60, unidade: "g" },
            { tipo: "MINERAIS", codigo: "MD1020", descricao: "Sulfato de cobre", lote: "03010379/0725", quantidade: 400.40, unidade: "g" },
            { tipo: "MINERAIS", codigo: "PQ704", descricao: "Bisglicinato de cobre", lote: "2527/25", quantidade: 400, unidade: "g" }
        ];


        let todosOsProdutos = [];
        let salaAtiva = 'boas-vindas';
        let sidebarAberta = true; // Começa aberta na tela de boas-vindas
        let unsubscribe = null; // Para o listener do Firestore

        // Elementos da DOM
        const sidebar = document.getElementById('sidebar');
        const sidebarNav = document.getElementById('sidebar-nav');
        const mainContent = document.getElementById('main-content');
        const contentArea = document.getElementById('content-area');
        const productGrid = document.getElementById('product-grid');
        const noItemsMessage = document.getElementById('no-items-message');
        const salaTitle = document.getElementById('sala-title');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const searchBar = document.getElementById('search-bar');
        const addItemBtn = document.getElementById('add-item-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // Elementos do Modal de Item
        const itemModalBackdrop = document.getElementById('item-modal-backdrop');
        const itemModal = document.getElementById('item-modal');
        const itemForm = document.getElementById('item-form');
        const modalTitle = document.getElementById('modal-title');
        const itemIdInput = document.getElementById('item-id');
        const itemSalaSelect = document.getElementById('item-sala');
        const itemCodigoInput = document.getElementById('item-codigo');
        const itemDescricaoInput = document.getElementById('item-descricao');
        const itemLoteInput = document.getElementById('item-lote');
        const itemQuantidadeInput = document.getElementById('item-quantidade');
        const itemUnidadeInput = document.getElementById('item-unidade');
        const itemAlertaInput = document.getElementById('item-alerta');
        const tipoContainer = document.getElementById('tipo-container');
        const itemObservacoesInput = document.getElementById('item-observacoes');
        
        // Elementos do Modal de Retirada
        const retiradaModalBackdrop = document.getElementById('retirada-modal-backdrop');
        const retiradaModal = document.getElementById('retirada-modal');
        const retiradaForm = document.getElementById('retirada-form');
        const retiradaItemIdInput = document.getElementById('retirada-item-id');
        const retiradaItemNome = document.getElementById('retirada-item-nome');
        const retiradaEstoqueAtual = document.getElementById('retirada-estoque-atual');
        const retiradaQuantidadeInput = document.getElementById('retirada-quantidade');
        const retiradaMotivoInput = document.getElementById('retirada-motivo');

        // Toast (Notificação)
        const toast = document.getElementById('toast');

        // ---- INICIALIZAÇÃO ----

        // Função principal de inicialização
        async function initApp() {
            console.log("Iniciando app...");
            renderSidebar();
            preencherSelectSalas();
            addEventListeners();
            
            try {
                // FORÇA O LOGIN ANÔNIMO para usar o projeto Firebase do usuário.
                // Ignora o token do ambiente (__initial_auth_token) que causa o erro "auth/custom-token-mismatch".
                console.log("Forçando autenticação anônima...");
                await signInAnonymously(auth);
                
            } catch (error) {
                console.error("Erro durante o login:", error);
                showToast(`Erro de autenticação: ${error.message}`, 'bg-red-600');
                loadingSpinner.style.display = 'none';
                return;
            }

            // O onAuthStateChanged vai lidar com o carregamento dos dados
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Usuário autenticado:", user.uid);
                    userId = user.uid;
                    
                    // ATUALIZAÇÃO PARA CAMINHO PÚBLICO
                    // Todos os usuários (autenticados anonimamente) lerão/escreverão
                    // no mesmo local "público".
                    const collectionPath = `artifacts/${appId}/public/data/salas-produtos`;
                    produtosCollectionRef = collection(db, collectionPath);
                    console.log("Usando caminho público do Firestore:", collectionPath);
                    
                    // Inicia o listener em tempo real
                    iniciarListenerFirestore();
                } else {
                    console.log("Usuário não autenticado.");
                    loadingSpinner.style.display = 'none';
                    showToast('Erro: Não foi possível autenticar.', 'bg-red-600');
                }
            });
        }
        
        // Inicia o listener do Firestore para dados em tempo real
        function iniciarListenerFirestore() {
            console.log("Iniciando listener do Firestore...");
            if (unsubscribe) unsubscribe(); // Cancela listener anterior, se houver
            
            // Ouve por mudanças na coleção inteira
            unsubscribe = onSnapshot(produtosCollectionRef, async (snapshot) => {
                console.log("Dados recebidos do Firestore. Documentos:", snapshot.size);
                
                // Primeira vez? Verifica se precisa popular os dados iniciais
                if (snapshot.empty) {
                    console.log("Banco de dados vazio. Populando com dados iniciais...");
                    await popularDadosIniciais();
                    // O listener vai pegar os novos dados, não precisa fazer mais nada
                    return; 
                }
                
                // Processa os dados recebidos
                todosOsProdutos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Renderiza a sala ativa (ou boas-vindas)
                if (salaAtiva === 'boas-vindas') {
                    mostrarTelaBoasVindas();
                } else {
                    renderizarProdutos(salaAtiva);
                }
                
                loadingSpinner.style.display = 'none';

            }, (error) => {
                console.error("Erro ao ouvir dados do Firestore: ", error);
                showToast("Erro ao carregar dados. Verifique as regras do Firestore.", 'bg-red-600');
                loadingSpinner.style.display = 'none';
            });
        }
        
        // Popula o Firestore com dados iniciais se estiver vazio
        async function popularDadosIniciais() {
            console.log("Iniciando a escrita dos dados iniciais...");
            const batch = writeBatch(db);
            
            dadosIniciaisNutraceuticos.forEach(item => {
                const docRef = doc(produtosCollectionRef); // Cria nova referência de doc
                
                const nivelAlerta = calcularNivelAlertaPadrao(item.quantidade, item.unidade);
                
                batch.set(docRef, {
                    ...item,
                    sala: 'nutraceuticos', // Define a sala para os dados iniciais
                    observacoes: "", // Campo de observações
                    alerta: nivelAlerta, // Nível de alerta automático
                    // Status não é mais salvo, é calculado
                });
            });
            
            try {
                await batch.commit();
                console.log("Dados iniciais populados com sucesso!");
                // O listener onSnapshot vai detectar essa mudança e recarregar
            } catch (error) {
                console.error("Erro ao popular dados iniciais:", error);
                showToast("Erro ao salvar dados iniciais.", 'bg-red-600');
            }
        }

        // ---- RENDERIZAÇÃO DA UI ----

        // Renderiza a barra lateral (Sidebar)
        function renderSidebar() {
            sidebarNav.innerHTML = ''; // Limpa a navegação
            
            // Link para Boas-Vindas
            const linkBoasVindas = criarLinkSidebar('boas-vindas', 'Boas-Vindas', 'fa-home', 'text-blue-400');
            sidebarNav.appendChild(linkBoasVindas);
            
            // Links das Salas
            salas.forEach(sala => {
                const link = criarLinkSidebar(sala.id, sala.nome, sala.icon, sala.color);
                sidebarNav.appendChild(link);
            });
        }
        
        // Função auxiliar para criar links da sidebar
        function criarLinkSidebar(id, nome, icon, color) {
            const a = document.createElement('a');
            a.href = '#';
            a.dataset.sala = id;
            a.className = `flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors ${salaAtiva === id ? 'bg-gray-700 text-white' : ''}`;
            a.innerHTML = `
                <i class="fas ${icon} w-6 text-center ${color}"></i>
                <span class="ml-4 font-medium">${nome}</span>
            `;
            a.onclick = (e) => {
                e.preventDefault();
                mudarDeSala(id);
            };
            return a;
        }
        
        // Preenche o <select> de salas no modal
        function preencherSelectSalas() {
            itemSalaSelect.innerHTML = '<option value="" disabled selected>Selecione uma sala</option>';
            salas.forEach(sala => {
                const option = document.createElement('option');
                option.value = sala.id;
                option.textContent = sala.nome;
                itemSalaSelect.appendChild(option);
            });
        }

        // Renderiza os produtos na tela
        function renderizarProdutos(idSala) {
            // Esconde a tela de boas-vindas e mostra a grade
            document.getElementById('welcome-screen').classList.add('hidden');
            productGrid.classList.remove('hidden');
            
            productGrid.innerHTML = ''; // Limpa a grade
            const filtroBusca = searchBar.value.toLowerCase();

            const produtosDaSala = todosOsProdutos.filter(p => p.sala === idSala);
            
            const produtosFiltrados = produtosDaSala.filter(p => 
                p.codigo.toLowerCase().includes(filtroBusca) ||
                p.descricao.toLowerCase().includes(filtroBusca)
            );
            
            // Ordena por código
            produtosFiltrados.sort((a, b) => a.codigo.localeCompare(b.codigo));
            
            // Atualiza mensagem de "nenhum item"
            if (produtosFiltrados.length === 0) {
                noItemsMessage.classList.remove('hidden');
            } else {
                noItemsMessage.classList.add('hidden');
            }

            // Cria e adiciona os cards
            produtosFiltrados.forEach(item => {
                const card = criarCardProduto(item);
                productGrid.appendChild(card);
            });
        }
        
        // Mostra a tela de Boas-Vindas
        function mostrarTelaBoasVindas() {
            document.getElementById('welcome-screen').classList.remove('hidden');
            productGrid.classList.add('hidden');
            noItemsMessage.classList.add('hidden');
        }

        // Função auxiliar para criar o card de um produto
        function criarCardProduto(item) {
            const card = document.createElement('div');
            
            // Lógica de Status (Calculado)
            let status = 'Em Estoque';
            let statusBg = 'bg-green-100';
            let statusText = 'text-green-800';
            let statusRing = 'ring-green-400';
            
            const quantidadeNum = parseFloat(item.quantidade);
            const alertaNum = parseFloat(item.alerta);

            if (quantidadeNum <= 0) {
                status = 'Esgotado';
                statusBg = 'bg-red-100';
                statusText = 'text-red-800';
                statusRing = 'ring-red-400';
            } else if (quantidadeNum <= alertaNum) {
                status = 'Baixo Estoque';
                statusBg = 'bg-yellow-100';
                statusText = 'text-yellow-800';
                statusRing = 'ring-yellow-400';
            }

            card.className = `bg-white rounded-xl shadow-lg overflow-hidden flex flex-col transition-all duration-300 hover:shadow-xl ring-2 ring-transparent hover:${statusRing}`;
            
            // Formata as observações para o tooltip
            const obsFormatada = item.observacoes ? item.observacoes.replace(/\\n/g, '\n') : 'Sem observações';

            card.innerHTML = `
                <!-- Cabeçalho do Card (Status e Código) -->
                <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                    <span class="px-3 py-1 text-xs font-bold ${statusBg} ${statusText} rounded-full">${status}</span>
                    ${item.observacoes ? `<i class="fas fa-info-circle text-blue-400" data-tooltip="${obsFormatada}"></i>` : ''}
                </div>

                <!-- Corpo do Card -->
                <div class="p-5 flex-1">
                    <div class="mb-3">
                        <p class="text-xs font-semibold text-blue-600 tracking-wide uppercase">CÓDIGO</p>
                        <h3 class="text-2xl font-bold text-gray-900">${item.codigo}</h3>
                    </div>
                    <p class="text-gray-700 font-medium mb-3 h-12">${item.descricao}</p>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="text-gray-500">Lote</p>
                            <p class="font-semibold text-gray-800">${item.lote || '--'}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Tipo</p>
                            <p class="font-semibold text-gray-800">${item.tipo || '--'}</p>
                        </div>
                    </div>
                </div>

                <!-- Quantidade (Rodapé) -->
                <div class="px-5 py-4 bg-gray-50">
                    <p class="text-sm text-gray-500">Quantidade em Estoque</p>
                    <p class="text-3xl font-bold text-gray-900">
                        ${quantidadeNum.toLocaleString('pt-BR')} <span class="text-xl font-medium text-gray-500">${item.unidade}</span>
                    </p>
                    <p class="text-xs text-gray-400 mt-1">Alerta: ${alertaNum} ${item.unidade}</p>
                </div>

                <!-- Ações -->
                <div class="flex border-t">
                    <button class="btn-retirada flex-1 py-3 px-4 text-sm font-medium text-red-600 hover:bg-red-50 transition-colors" data-id="${item.id}">
                        <i class="fas fa-minus-circle mr-2"></i>Dar Baixa
                    </button>
                    <button class="btn-editar flex-1 py-3 px-4 text-sm font-medium text-blue-600 hover:bg-blue-50 transition-colors border-l" data-id="${item.id}">
                        <i class="fas fa-pencil-alt mr-2"></i>Editar
                    </button>
                    <button class="btn-excluir px-4 py-3 text-sm font-medium text-gray-500 hover:bg-gray-100 hover:text-red-600 transition-colors border-l" data-id="${item.id}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            
            // Adiciona listeners aos botões do card
            card.querySelector('.btn-retirada').addEventListener('click', () => abrirModalRetirada(item.id));
            card.querySelector('.btn-editar').addEventListener('click', () => abrirModalItem('edit', item.id));
            card.querySelector('.btn-excluir').addEventListener('click', () => excluirItem(item.id));

            return card;
        }
        
        // ---- LÓGICA DE NEGÓCIO E EVENTOS ----

        // Adiciona os principais event listeners da página
        function addEventListeners() {
            // Botão de toggle do menu (mobile)
            menuToggleBtn.addEventListener('click', () => {
                sidebarAberta = !sidebarAberta;
                updateLayout();
            });
            
            // Botão de Adicionar Item
            addItemBtn.addEventListener('click', () => abrirModalItem('add'));
            
            // Fechar Modais
            document.querySelectorAll('.modal-close-btn, .modal-backdrop').forEach(btn => {
                btn.addEventListener('click', () => {
                    fecharModalItem();
                    fecharModalRetirada();
                });
            });
            
            // Formulário de Adicionar/Editar Item
            itemForm.addEventListener('submit', salvarItem);
            
            // Formulário de Retirada
            retiradaForm.addEventListener('submit', salvarRetirada);
            
            // Barra de Busca
            searchBar.addEventListener('input', () => {
                if (salaAtiva !== 'boas-vindas') {
                    renderizarProdutos(salaAtiva);
                }
            });
            
            // Atualiza o <select> de Tipo quando a Sala muda no modal
            itemSalaSelect.addEventListener('change', (e) => {
                renderizarCampoTipo(e.target.value);
            });
        }
        
        // Atualiza o layout (abrir/fechar sidebar)
        function updateLayout() {
            if (sidebarAberta) {
                sidebar.classList.remove('-translate-x-full');
                mainContent.classList.add('md:ml-64');
            } else {
                sidebar.classList.add('-translate-x-full');
                mainContent.classList.remove('md:ml-64');
            }
        }

        // Navega para uma sala diferente
        function mudarDeSala(idSala) {
            salaAtiva = idSala;
            const sala = salas.find(s => s.id === idSala);
            
            // Define o título da página
            salaTitle.textContent = sala ? sala.nome : 'Boas-Vindas';
            
            // Atualiza a sidebar (destaque)
            renderSidebar(); 
            
            // Renderiza o conteúdo
            if (idSala === 'boas-vindas') {
                mostrarTelaBoasVindas();
            } else {
                renderizarProdutos(idSala);
            }
            
            // Fecha a sidebar em telas pequenas
            if (window.innerWidth < 768) {
                sidebarAberta = false;
                updateLayout();
            }
        }
        
        // Renderiza o campo "Tipo" dinamicamente no modal
        function renderizarCampoTipo(idSala, valorAtual = '') {
            tipoContainer.innerHTML = ''; // Limpa o container
            
            if (idSala === 'sorvetes') {
                // Campo <select> para Sorvetes
                const label = document.createElement('label');
                label.setAttribute('for', 'item-tipo');
                label.className = 'block text-sm font-medium text-gray-700 mb-1';
                label.textContent = 'Tipo (Obrigatório)';
                
                const select = document.createElement('select');
                select.id = 'item-tipo';
                select.required = true;
                select.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500';
                
                const opcoes = [
                    { value: '', text: 'Selecione um tipo', disabled: true },
                    { value: 'Recheio', text: 'Recheio' },
                    { value: 'Pó', text: 'Pó' },
                    { value: 'Pasta', text: 'Pasta' }
                ];
                
                opcoes.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    if (opt.disabled) option.disabled = true;
                    if (opt.value === valorAtual) {
                        option.selected = true;
                    } else if (!valorAtual && opt.disabled) {
                         option.selected = true; // Seleciona "Selecione um tipo" se não houver valor
                    }
                });
                
                tipoContainer.appendChild(label);
                tipoContainer.appendChild(select);
                
            } else {
                // Campo <input> de texto para outras salas
                const label = document.createElement('label');
                label.setAttribute('for', 'item-tipo');
                label.className = 'block text-sm font-medium text-gray-700 mb-1';
                label.textContent = 'Tipo (Opcional)';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'item-tipo';
                input.value = valorAtual;
                input.placeholder = 'Ex: BIOATIVO, FIBRAS...';
                input.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500';
                
                tipoContainer.appendChild(label);
                tipoContainer.appendChild(input);
            }
        }
        
        // Calcula o nível de alerta padrão com base na unidade
        function calcularNivelAlertaPadrao(quantidade, unidade) {
            const uni = unidade.toLowerCase().trim();
            if (uni === 'g' || uni === 'gr') {
                return 200; // Regra do usuário: 200g
            } else if (uni === 'kg') {
                return 5; // 5kg
            } else if (uni === 'un' || uni === 'unidade' || uni === 'unidades') {
                return 10; // 10 unidades
            }
            // Padrão: 10% da quantidade inicial ou 10
            const qtNum = parseFloat(quantidade);
            return qtNum > 100 ? Math.round(qtNum * 0.1) : 10;
        }

        // ---- MODAIS ----

        // Abrir Modal de Adicionar/Editar
        function abrirModalItem(mode, id = null) {
            itemForm.reset();
            itemIdInput.value = '';
            
            if (mode === 'add') {
                modalTitle.textContent = 'Adicionar Novo Item';
                // Define a sala ativa no modal, se não for "boas-vindas"
                if (salaAtiva !== 'boas-vindas') {
                    itemSalaSelect.value = salaAtiva;
                }
                renderizarCampoTipo(itemSalaSelect.value); // Renderiza o campo tipo para a sala
                
                // Limpa o campo de alerta para que o cálculo automático funcione
                itemAlertaInput.value = ''; 
                
            } else if (mode === 'edit') {
                modalTitle.textContent = 'Editar Item';
                const item = todosOsProdutos.find(p => p.id === id);
                if (item) {
                    itemIdInput.value = item.id;
                    itemSalaSelect.value = item.sala;
                    itemCodigoInput.value = item.codigo;
                    itemDescricaoInput.value = item.descricao;
                    itemLoteInput.value = item.lote;
                    itemQuantidadeInput.value = item.quantidade;
                    itemUnidadeInput.value = item.unidade;
                    itemAlertaInput.value = item.alerta;
                    // Renderiza o campo tipo e preenche com o valor atual
                    renderizarCampoTipo(item.sala, item.tipo); 
                    itemObservacoesInput.value = item.observacoes ? item.observacoes.replace(/\\n/g, '\n') : '';
                }
            }

            itemModal.style.display = 'block';
            itemModalBackdrop.style.display = 'block';
            setTimeout(() => {
                itemModal.style.opacity = 1;
                itemModal.style.transform = 'translate(-50%, -50%)';
                itemModalBackdrop.style.opacity = 1;
            }, 10);
        }

        // Fechar Modal de Adicionar/Editar
        function fecharModalItem() {
            itemModal.style.opacity = 0;
            itemModal.style.transform = 'translate(-50%, -60%)';
            itemModalBackdrop.style.opacity = 0;
            setTimeout(() => {
                itemModal.style.display = 'none';
                itemModalBackdrop.style.display = 'none';
            }, 300);
        }
        
        // Abrir Modal de Retirada
        function abrirModalRetirada(id) {
            const item = todosOsProdutos.find(p => p.id === id);
            if (!item) return;

            retiradaForm.reset();
            retiradaItemIdInput.value = item.id;
            retiradaItemNome.textContent = item.descricao;
            retiradaEstoqueAtual.textContent = `${item.quantidade} ${item.unidade}`;
            
            retiradaModal.style.display = 'block';
            retiradaModalBackdrop.style.display = 'block';
            setTimeout(() => {
                retiradaModal.style.opacity = 1;
                retiradaModal.style.transform = 'translate(-50%, -50%)';
                retiradaModalBackdrop.style.opacity = 1;
            }, 10);
        }
        
        // Fechar Modal de Retirada
        function fecharModalRetirada() {
            retiradaModal.style.opacity = 0;
            retiradaModal.style.transform = 'translate(-50%, -60%)';
            retiradaModalBackdrop.style.opacity = 0;
            setTimeout(() => {
                retiradaModal.style.display = 'none';
                retiradaModalBackdrop.style.display = 'none';
            }, 300);
        }

        // ---- AÇÕES (CRUD) COM FIREBASE ----

        // Salvar (Adicionar ou Editar) um item
        async function salvarItem(e) {
            e.preventDefault();
            loadingSpinner.style.display = 'flex';
            
            const id = itemIdInput.value;
            const sala = itemSalaSelect.value;
            const tipoInput = document.getElementById('item-tipo'); // Pega o campo tipo dinâmico
            
            // Se o nível de alerta não foi preenchido, calcula o padrão
            let nivelAlerta = parseFloat(itemAlertaInput.value);
            if (isNaN(nivelAlerta) || nivelAlerta <= 0) {
                nivelAlerta = calcularNivelAlertaPadrao(
                    parseFloat(itemQuantidadeInput.value),
                    itemUnidadeInput.value
                );
            }

            const novoItem = {
                sala: sala,
                codigo: itemCodigoInput.value,
                descricao: itemDescricaoInput.value,
                lote: itemLoteInput.value,
                quantidade: parseFloat(itemQuantidadeInput.value) || 0,
                unidade: itemUnidadeInput.value,
                alerta: nivelAlerta,
                tipo: tipoInput ? tipoInput.value : '', // Salva o valor do campo tipo
                observacoes: itemObservacoesInput.value.replace(/\n/g, '\\n'), // Salva quebras de linha
            };

            try {
                if (id) {
                    // --- Editar (Update) ---
                    const docRef = doc(produtosCollectionRef, id);
                    await updateDoc(docRef, novoItem);
                    showToast('Item atualizado com sucesso!', 'bg-green-600');
                } else {
                    // --- Adicionar (Add) ---
                    await addDoc(produtosCollectionRef, novoItem);
                    showToast('Item adicionado com sucesso!', 'bg-green-600');
                }
                
                fecharModalItem();
                // Não precisa recarregar, o onSnapshot faz isso
                
            } catch (error) {
                console.error("Erro ao salvar item:", error);
                showToast('Erro ao salvar item.', 'bg-red-600');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
        
        // Salvar Retirada (Dar Baixa)
        async function salvarRetirada(e) {
            e.preventDefault();
            loadingSpinner.style.display = 'flex';
            
            const id = retiradaItemIdInput.value;
            const qtdeRetirada = parseFloat(retiradaQuantidadeInput.value);
            const motivo = retiradaMotivoInput.value;
            
            const item = todosOsProdutos.find(p => p.id === id);
            if (!item) {
                showToast('Erro: Item não encontrado.', 'bg-red-600');
                loadingSpinner.style.display = 'none';
                return;
            }
            
            if (isNaN(qtdeRetirada) || qtdeRetirada <= 0) {
                showToast('Erro: Quantidade inválida.', 'bg-red-600');
                loadingSpinner.style.display = 'none';
                return;
            }
            
            const novaQuantidade = item.quantidade - qtdeRetirada;
            
            // Cria uma nota de observação para a retirada
            const dataHoje = new Date().toLocaleDateString('pt-BR');
            const notaRetirada = `[${dataHoje}] Retirada de ${qtdeRetirada} ${item.unidade}${motivo ? ': ' + motivo : ''}.`;
            
            // Adiciona a nova nota no topo das observações existentes
            const novasObservacoes = `${notaRetirada}\\n${item.observacoes || ''}`.replace(/\n/g, '\\n');
            
            try {
                const docRef = doc(produtosCollectionRef, id);
                await updateDoc(docRef, {
                    quantidade: novaQuantidade,
                    observacoes: novasObservacoes
                });
                
                showToast('Baixa realizada com sucesso!', 'bg-green-600');
                fecharModalRetirada();
                // onSnapshot recarrega
                
            } catch (error) {
                console.error("Erro ao dar baixa:", error);
                showToast('Erro ao dar baixa.', 'bg-red-600');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        // Excluir um item
        async function excluirItem(id) {
            // Usamos um modal customizado em vez de confirm()
            // NOTA: window.confirm() é bloqueado no ambiente. 
            // Para uma versão final, o ideal seria criar um modal de confirmação.
            // Por enquanto, usaremos o confirm() padrão do navegador.
            if (!confirm('Tem certeza que deseja excluir este item permanentemente?')) {
                return;
            }
            
            loadingSpinner.style.display = 'flex';

            try {
                const docRef = doc(produtosCollectionRef, id);
                await deleteDoc(docRef);
                showToast('Item excluído com sucesso!', 'bg-green-600');
                // onSnapshot recarrega
            } catch (error) {
                console.error("Erro ao excluir item:", error);
                showToast('Erro ao excluir item.', 'bg-red-600');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
        
        // ---- UTILITÁRIOS ----
        
        // Mostrar notificação (toast)
        function showToast(message, bgColorClass) {
            toast.textContent = message;
            toast.className = bgColorClass; // Remove classes antigas
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Inicializa o app quando a DOM estiver pronta
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
